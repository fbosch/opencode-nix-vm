include <tunables/global>

profile opencode flags=(attach_disconnected,mediate_deleted) {
  include <abstractions/base>
  include <abstractions/nameservice>

  network,
  capability,

  / r,
  /nix/store/ r,
  /nix/store/** mrix,
  /run/current-system/sw/** mrix,
  /run/current-system/sw/bin/** mrix,

  /root/ r,
  /root/** rwkl,
  /tmp/ r,
  /tmp/** rwkm,
  /run/ r,
  /run/** rwk,
  /dev/{null,tty,ptmx,random,urandom,hvc0} rw,

  /project/ r,
  /project/** rwk,
  
  # Restrict /host-data/opencode writes to specific subdirectories
  /host-data/ r,
  /host-data/opencode/ rl,
  /host-data/opencode/auth.json r,
  /host-data/opencode/bin/ rwkl,
  /host-data/opencode/bin/** rwkl,
  /host-data/opencode/cache/ rwkl,
  /host-data/opencode/cache/** rwkl,
  /host-data/opencode/config/ rwkl,
  /host-data/opencode/config/** rwkl,
  /host-data/opencode/log/ rwkl,
  /host-data/opencode/log/** rwkl,
  /host-data/opencode/snapshot/ rwkl,
  /host-data/opencode/snapshot/** rwkl,
  /host-data/opencode/state/ rwkl,
  /host-data/opencode/state/** rwkl,
  /host-data/opencode/storage/ rwkl,
  /host-data/opencode/storage/** rwkl,
  /host-data/opencode/tool-output/ rwkl,
  /host-data/opencode/tool-output/** rwkl,
  /host-data/opencode/exports/ rwkl,
  /host-data/opencode/exports/** rwkl,
  # Deny writing executable scripts to root of host-data
  deny /host-data/opencode/*.sh wl,
  deny /host-data/opencode/*.py wl,
  deny /host-data/opencode/*.js wl,
  deny /host-data/opencode/*.bash wl,
  deny /host-data/opencode/*.exe wl,
  
  /host-config/opencode/** r,
  /host-config/agents/** r,
  /run/opencode-host/** r,

  /proc/** r,
  /sys/** r,
}
